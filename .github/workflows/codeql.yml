name: CodeQL
on:
  push:
    branches:
      - 'jarz/**'
      - 'copilot/**'
      - 'dev'
  pull_request:
    branches:
      - 'jarz/**'
      - 'dev'
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday at 06:00 UTC
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  security-events: write
jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Install dependencies
      run: |
        sudo apt-get update -y -qq
        sudo apt-get install -y -qq libsdl2-dev ninja-build
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        queries: security-and-quality
        config-file: .github/codeql/codeql-config.yml
    - name: Configure CMake
      run: >
        cmake -S . -B build -GNinja
        -DCMAKE_BUILD_TYPE=Release
        -DDPPC_68K_DEBUGGER=ON
        -DDPPC_BUILD_PPC_TESTS=ON
    - name: Build
      run: cmake --build build --parallel
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: cpp
